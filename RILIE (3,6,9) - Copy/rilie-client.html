<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RILIE (3,6,9)</title>
  <link rel="icon" type="image/png" href="/static/3Dent.png" />
  <link rel="apple-touch-icon" href="/static/3Dent.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      background: #0a0a0a;
      background-image:
        radial-gradient(ellipse at 20% 50%, rgba(30,30,40,0.6) 0%, transparent 70%),
        radial-gradient(ellipse at 80% 50%, rgba(20,20,30,0.4) 0%, transparent 70%);
      color: #e8e8e8;
      font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      -webkit-font-smoothing: antialiased;
    }

    /* Sidebar */
    .rilie-sidebar {
      width: 56px;
      min-height: 100vh;
      background: linear-gradient(180deg, #0c0c10 0%, #08080c 100%);
      border-right: 1px solid rgba(255,255,255,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 0;
      gap: 6px;
      position: fixed;
      left: 0;
      top: 0;
      z-index: 100;
    }
    .sidebar-logo {
      width: 30px;
      height: 30px;
      margin-bottom: 12px;
      filter: drop-shadow(0 1px 6px rgba(255,255,255,0.06));
    }
    .sidebar-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    .sidebar-btn svg {
      width: 18px;
      height: 18px;
      stroke: rgba(255,255,255,0.3);
      fill: none;
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: stroke 0.2s ease;
    }
    .sidebar-btn:hover { background: rgba(255,255,255,0.05); }
    .sidebar-btn:hover svg { stroke: rgba(255,255,255,0.6); }
    .sidebar-btn.active { background: rgba(255,255,255,0.07); }
    .sidebar-btn.active svg { stroke: rgba(255,255,255,0.7); }
    .sidebar-label {
      font-size: 8px;
      color: rgba(255,255,255,0.2);
      letter-spacing: 0.04em;
      text-align: center;
      margin-top: -2px;
      font-weight: 500;
    }
    .sidebar-spacer { flex: 1; }

    /* Main Content */
    .rilie-main {
      flex: 1;
      margin-left: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .rilie-shell {
      width: 100%;
      max-width: 980px;
      padding: 32px 28px;
      animation: fadeUp 0.6s ease-out;
    }
    .rilie-title {
      text-align: left;
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 0.02em;
      background: linear-gradient(180deg, #fff 0%, #aab 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-top: 16px;
    }
    .rilie-subtitle {
      text-align: left;
      font-size: 13px;
      font-weight: 400;
      color: rgba(255,255,255,0.45);
      margin-top: 4px;
      margin-bottom: 0;
      letter-spacing: 0.03em;
    }

    /* Top bar */
    .rilie-top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 28px;
    }
    .rilie-top-right {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
      min-width: 140px;
    }
    .rilie-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(255,255,255,0.5);
    }

    /* Textarea */
    .rilie-textarea {
      width: 100%;
      margin-top: 8px;
      margin-bottom: 18px;
      padding: 14px 16px 50px 50px;
      background: linear-gradient(180deg, #0e0e10 0%, #141418 100%);
      color: #ddd;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      resize: none;
      min-height: 60px;
      max-height: 200px;
      font-family: inherit;
      font-size: 18px;
      line-height: 1.6;
      outline: none;
      transition: border-color 0.25s ease, box-shadow 0.25s ease;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.4);
    }
    .rilie-textarea:focus {
      border-color: rgba(255,255,255,0.18);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.4), 0 0 0 3px rgba(255,255,255,0.04);
    }
    .rilie-textarea::placeholder { color: rgba(255,255,255,0.22); }

    /* Input wrapper */
    .rilie-input-wrap {
      position: relative;
      margin-bottom: 18px;
    }

    /* Button inside textarea */
    .rilie-textarea-button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 8px 14px;
      font-size: 12px;
      z-index: 10;
    }

    /* File upload button inside textarea */
    .rilie-textarea-file-btn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 6px;
      background: rgba(255,255,255,0.08);
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10;
    }
    .rilie-textarea-file-btn:hover { background: rgba(255,255,255,0.12); }
    .rilie-textarea-file-btn svg {
      width: 16px; height: 16px;
      stroke: rgba(255,255,255,0.6); fill: none;
      stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
    }

    /* Primary Aero Glass */
    .rilie-button {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 11px 28px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.2s ease;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.08) 45%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.15) 100%),
        linear-gradient(180deg, #3a3a44 0%, #222228 100%);
      box-shadow:
        0 1px 0 rgba(255,255,255,0.12) inset,
        0 -1px 0 rgba(0,0,0,0.3) inset,
        0 2px 8px rgba(0,0,0,0.5),
        0 1px 2px rgba(0,0,0,0.3);
      text-shadow: 0 -1px 1px rgba(0,0,0,0.4);
    }
    .rilie-button::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.02) 100%);
      border-radius: 8px 8px 0 0;
      pointer-events: none;
    }
    .rilie-button:hover {
      background:
        linear-gradient(180deg, rgba(255,255,255,0.28) 0%, rgba(255,255,255,0.12) 45%, rgba(0,0,0,0.02) 50%, rgba(0,0,0,0.1) 100%),
        linear-gradient(180deg, #444450 0%, #2a2a30 100%);
    }
    .rilie-button:active {
      background:
        linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.05) 45%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0.05) 100%),
        linear-gradient(180deg, #1a1a20 0%, #2a2a30 100%);
    }
    .rilie-button:disabled { opacity: 0.35; cursor: default; }

    /* Secondary subtle glass */
    .rilie-button-sm {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 16px;
      font-family: inherit;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.03em;
      color: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 7px;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.2s ease;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 48%, rgba(0,0,0,0.04) 52%, rgba(0,0,0,0.08) 100%),
        linear-gradient(180deg, #1a1a1e 0%, #111114 100%);
      box-shadow: 0 1px 0 rgba(255,255,255,0.04) inset, 0 1px 4px rgba(0,0,0,0.3);
    }
    .rilie-button-sm::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, transparent 100%);
      border-radius: 6px 6px 0 0;
      pointer-events: none;
    }
    .rilie-button-sm:hover {
      color: rgba(255,255,255,0.8);
      border-color: rgba(255,255,255,0.14);
    }

    /* Output */
    .rilie-output-label {
      margin-top: 28px;
      margin-bottom: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(255,255,255,0.5);
    }
    .rilie-output-wrap { position: relative; }
    .rilie-output {
      padding: 0;
      background: transparent;
      border: none;
      font-family: 'Outfit', Consolas, Menlo, monospace;
      font-size: 18px;
      line-height: 1.7;
      color: rgba(255,255,255,0.85);
      min-height: 200px;
      max-height: 70vh;
      overflow-y: auto;
      margin-bottom: 24px;
    }
    .rilie-output::-webkit-scrollbar { width: 6px; }
    .rilie-output::-webkit-scrollbar-track { background: transparent; }
    .rilie-output::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    .rilie-output::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    .rilie-output div { margin-bottom: 16px; padding: 0; }
    .rilie-output strong { color: rgba(255,255,255,0.95); }

    /* Code blocks */
    .rilie-code-block {
      position: relative;
      margin: 10px 0;
      padding: 10px 12px;
      background: #050507;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.12);
      font-family: Consolas, Menlo, Monaco, monospace;
      font-size: 12px;
      overflow-x: auto;
    }
    .rilie-code-block pre { margin: 0; white-space: pre; }
    .rilie-code-copy {
      position: absolute;
      top: 6px; right: 8px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 5px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Output actions */
    .rilie-output-actions {
      display: none;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      justify-content: flex-end;
    }
    .rilie-output-actions.visible { display: flex; }
    .rilie-action-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 5px 12px;
      font-family: inherit;
      font-size: 10px;
      font-weight: 500;
      color: rgba(255,255,255,0.35);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 6px;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.2s ease;
      background: linear-gradient(180deg, rgba(255,255,255,0.04) 0%, rgba(0,0,0,0.04) 100%), #0e0e12;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .rilie-action-btn:hover {
      color: rgba(255,255,255,0.6);
      border-color: rgba(255,255,255,0.1);
    }
    .rilie-action-btn svg {
      width: 12px; height: 12px;
      stroke: currentColor; fill: none;
      stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
    }
    .rilie-action-btn.copied { color: #5a8; border-color: rgba(85,170,136,0.3); }

    /* Meta panel */
    .rilie-meta {
      margin-top: 18px;
      padding: 12px 14px;
      background: linear-gradient(180deg, #0a0a0e 0%, #08080c 100%);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 8px;
      font-size: 11px;
      font-family: 'Outfit', Consolas, Menlo, monospace;
      color: #555;
      display: none;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
    }
    .rilie-meta.visible { display: block; }
    .rilie-meta-row { display: flex; justify-content: space-between; padding: 2px 0; }
    .rilie-meta-key { color: rgba(255,255,255,0.25); }
    .rilie-meta-val { color: rgba(255,255,255,0.45); }
    .rilie-meta-val.green { color: #5a8; }
    .rilie-meta-val.yellow { color: #aa8; }
    .rilie-meta-val.orange { color: #a85; }
    .rilie-meta-val.red { color: #a55; }

    /* Health bar */
    .rilie-health-bar {
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 10px;
      color: rgba(255,255,255,0.2);
      font-weight: 500;
      letter-spacing: 0.05em;
    }
    .rilie-health-track {
      flex: 1;
      height: 3px;
      background: rgba(255,255,255,0.04);
      border-radius: 2px;
      overflow: hidden;
    }
    .rilie-health-fill {
      height: 100%;
      background: linear-gradient(90deg, #4a7 0%, #5a8 100%);
      border-radius: 2px;
      transition: width 0.4s ease, background 0.4s ease;
      box-shadow: 0 0 6px rgba(85,170,136,0.3);
    }

    /* Footer */
    .rilie-footer {
      margin-top: 36px;
      text-align: center;
      font-size: 10px;
      color: rgba(255,255,255,0.15);
      line-height: 1.7;
      letter-spacing: 0.02em;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 640px) {
      .rilie-sidebar { width: 0; overflow: hidden; border: none; }
      .rilie-main { margin-left: 0; }
      .rilie-shell { padding: 24px 16px; }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <nav class="rilie-sidebar">
    <img src="/static/3Dent.png" alt="R" class="sidebar-logo" />

    <button class="sidebar-btn" id="sidebar-new" title="New Conversation">
      <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
    <span class="sidebar-label">New</span>

    <button class="sidebar-btn" id="sidebar-history" title="History">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    </button>
    <span class="sidebar-label">History</span>

    <button class="sidebar-btn active" id="sidebar-discover" title="Discover">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect></svg>
    </button>
    <span class="sidebar-label">Discover</span>

    <button class="sidebar-btn" id="sidebar-spaces" title="Spaces">
      <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
    </button>
    <span class="sidebar-label">Spaces</span>

    <div class="sidebar-spacer"></div>

    <button class="sidebar-btn" id="sidebar-finance" title="Finance">
      <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
    </button>
    <span class="sidebar-label">Finance</span>
  </nav>

  <!-- Main -->
  <div class="rilie-main">
    <div class="rilie-shell">

      <div class="rilie-top-bar">
        <div>
          <div class="rilie-title">RILIE (3,6,9)</div>
          <div class="rilie-subtitle">Real Intelligence, RI. Really? Play Around and Find Out :)</div>
        </div>
        <div class="rilie-top-right">
          <button class="rilie-button-sm" id="rilie-self">Who is RILIE?</button>
          <div class="rilie-health-bar">
            <span>conversation health</span>
            <div class="rilie-health-track">
              <div class="rilie-health-fill" id="health-fill" style="width: 100%"></div>
            </div>
            <span id="health-pct">100</span>
          </div>
        </div>
      </div>

      <!-- OUTPUT ON TOP -->
      <div class="rilie-output-label">Discourse</div>
      <div class="rilie-output-wrap">
        <div id="rilie-output" class="rilie-output"></div>
        <div id="rilie-output-actions" class="rilie-output-actions">
          <button class="rilie-action-btn" id="rilie-share" title="Share">
            <svg viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
          </button>
          <button class="rilie-action-btn" id="rilie-download" title="Download">
            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          </button>
          <button class="rilie-action-btn" id="rilie-copy" title="Copy">
            <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
          </button>
          <button class="rilie-action-btn" id="rilie-rewrite" title="Rewrite">
            <svg viewBox="0 0 24 24"><path d="M1 4v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
          </button>
        </div>
      </div>

      <!-- INPUT AT BOTTOM -->
      <label class="rilie-label" for="rilie-input">Your Turn</label>
      <div class="rilie-input-wrap">
        <textarea id="rilie-input" class="rilie-textarea" placeholder="What's on your mind?"></textarea>
        <label for="rilie-files" class="rilie-textarea-file-btn">
          <svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
        </label>
        <input id="rilie-files" type="file" multiple style="display: none" />
        <button class="rilie-button rilie-textarea-button" id="rilie-submit">Learn from Go</button>
      </div>

      <!-- Meta panel -->
      <div id="rilie-meta" class="rilie-meta">
        <div class="rilie-meta-row"><span class="rilie-meta-key">status</span><span class="rilie-meta-val" id="meta-status">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">quality</span><span class="rilie-meta-val" id="meta-quality">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">priorities</span><span class="rilie-meta-val" id="meta-priorities">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">anti-beige</span><span class="rilie-meta-val" id="meta-beige">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">depth / pass</span><span class="rilie-meta-val" id="meta-depth">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">tone</span><span class="rilie-meta-val" id="meta-tone">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">domains</span><span class="rilie-meta-val" id="meta-domains">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">wit</span><span class="rilie-meta-val" id="meta-wit">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">language</span><span class="rilie-meta-val" id="meta-language">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">social</span><span class="rilie-meta-val" id="meta-social">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">curiosity</span><span class="rilie-meta-val" id="meta-curiosity">&mdash;</span></div>
        <div class="rilie-meta-row"><span class="rilie-meta-key">triangle</span><span class="rilie-meta-val" id="meta-triangle">&mdash;</span></div>
      </div>

      <div class="rilie-footer">
        Inspired by those who gave without expecting anything in return (3),
        we're grateful (6)&mdash;and that's enough for us to do good work. (9)<br />
        Runs on RILIE Sauce &middot; 3.6.NIFE LLC &middot; Ri: Real Intelligence &#x1F531;
      </div>

    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const submitBtn = document.getElementById('rilie-submit');
      const selfBtn = document.getElementById('rilie-self');
      const inputEl = document.getElementById('rilie-input');
      const outputEl = document.getElementById('rilie-output');
      const metaPanel = document.getElementById('rilie-meta');
      const healthFill = document.getElementById('health-fill');
      const healthPct = document.getElementById('health-pct');
      const outputActions = document.getElementById('rilie-output-actions');
      const shareBtn = document.getElementById('rilie-share');
      const downloadBtn = document.getElementById('rilie-download');
      const copyBtn = document.getElementById('rilie-copy');
      const rewriteBtn = document.getElementById('rilie-rewrite');
      const fileInput = document.getElementById('rilie-files');
      let lastStimulus = '';

      function escapeHtml(str) {
        const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
        return str.replace(/[&<>"']/g, s => map[s]);
      }

      function attachCodeCopyHandlers(container) {
        container.querySelectorAll('.rilie-code-copy').forEach(function(btn) {
          btn.onclick = async function() {
            const code = btn.parentElement.querySelector('pre').innerText;
            try {
              await navigator.clipboard.writeText(code);
              btn.textContent = 'copied';
              setTimeout(function() { btn.textContent = 'copy'; }, 1200);
            } catch(e) {}
          };
        });
      }

      function renderWithCodeBlocks(prefix, text) {
        const parts = text.split('```');
        let html = '';
        let first = true;
        for (let i = 0; i < parts.length; i++) {
          const chunk = parts[i];
          if (i % 2 === 0) {
            if (chunk.trim()) {
              const label = first ? prefix : '';
              first = false;
              html += '<p>' + label + escapeHtml(chunk).replace(/\n/g, '<br>') + '</p>';
            }
          } else {
            const lines = chunk.split('\n');
            let codeLines = lines;
            if (lines[0] && lines[0].trim().match(/^[a-zA-Z0-9_-]+$/)) {
              codeLines = lines.slice(1);
            }
            const codeHtml = escapeHtml(codeLines.join('\n'));
            html += '<div class="rilie-code-block"><button class="rilie-code-copy">copy</button><pre><code>' + codeHtml + '</code></pre></div>';
          }
        }
        return html;
      }

      function updateMeta(data) {
        metaPanel.classList.add('visible');
        metaPanel.style.display = '';
        const set = function(id, val) {
          const el = document.getElementById(id);
          if (el) el.textContent = val || '\u2014';
        };
        set('meta-status', data.status);
        set('meta-quality', data.quality_score != null ? data.quality_score.toFixed(2) : '\u2014');
        set('meta-priorities', data.priorities_met);
        set('meta-beige', data.anti_beige_score != null ? data.anti_beige_score.toFixed(2) : '\u2014');
        set('meta-depth', (data.depth || 0) + ' / ' + (data.pass || 0));
        set('meta-tone', (data.tone_emoji || '') + ' ' + (data.tone || ''));
        set('meta-domains', (data.domains_used || []).join(', '));
        set('meta-triangle', data.triangle_type || 'CLEAN');

        const wit = data.wit || {};
        const witActive = Object.entries(wit).filter(function(e) { return e[1]; }).map(function(e) { return e[0]; });
        set('meta-wit', witActive.length ? witActive.join(', ') : 'none');

        const lang = data.language_mode || {};
        const langActive = Object.entries(lang).filter(function(e) { return e[1]; }).map(function(e) { return e[0]; });
        set('meta-language', langActive.length ? langActive.join(', ') : 'literal');

        const social = data.social || {};
        set('meta-social', social.user_status != null
          ? 'user=' + social.user_status.toFixed(2) + ' self=' + social.self_status.toFixed(2)
          : '\u2014');

        set('meta-curiosity', data.curiosity_informed ? 'own discovery used' : '\u2014');

        const health = data.conversation_health || 100;
        healthFill.style.width = health + '%';
        healthPct.textContent = Math.round(health);
        if (health > 70) {
          healthFill.style.background = 'linear-gradient(90deg, #4a7, #5a8)';
        } else if (health > 50) {
          healthFill.style.background = 'linear-gradient(90deg, #aa8, #bb9)';
        } else if (health > 30) {
          healthFill.style.background = 'linear-gradient(90deg, #a85, #b96)';
        } else {
          healthFill.style.background = 'linear-gradient(90deg, #a55, #b66)';
        }
      }

      // Submit
      submitBtn.onclick = async function() {
        const stimulus = inputEl.value.trim();
        if (!stimulus) {
          outputEl.textContent = 'Drop something in. A question, a thought, a vibe. Then hit Go.';
          return;
        }

        lastStimulus = stimulus;
        inputEl.value = '';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Going...';
        outputActions.classList.remove('visible');

        try {
          // User message
          const userDiv = document.createElement('div');
          userDiv.style.marginBottom = '16px';
          userDiv.innerHTML = '<strong>You:</strong> ' + escapeHtml(stimulus).replace(/\n/g, '<br>');
          outputEl.appendChild(userDiv);

          const files = fileInput.files;
          let res;
          if (files && files.length > 0) {
            const formData = new FormData();
            formData.append('stimulus', stimulus);
            formData.append('max_pass', '3');
            for (let i = 0; i < files.length; i++) {
              formData.append('files', files[i]);
            }
            res = await fetch('/v1/rilie', { method: 'POST', body: formData });
          } else {
            res = await fetch('/v1/rilie', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ stimulus: stimulus, max_pass: 3 })
            });
          }

          if (!res.ok) {
            const errDiv = document.createElement('div');
            errDiv.style.color = '#a55';
            errDiv.innerHTML = '<strong>Error:</strong> ' + res.status;
            outputEl.appendChild(errDiv);
            return;
          }

          const data = await res.json();
          const rilieLine = data.result || 'No result returned.';

          // RILIE response
          const rilieDiv = document.createElement('div');
          rilieDiv.style.marginBottom = '16px';
          rilieDiv.innerHTML = renderWithCodeBlocks('<strong>RILIE:</strong> ', rilieLine);
          outputEl.appendChild(rilieDiv);
          attachCodeCopyHandlers(rilieDiv);

          outputEl.scrollTop = outputEl.scrollHeight;
          updateMeta(data);
          outputActions.classList.add('visible');

        } catch(err) {
          const errDiv = document.createElement('div');
          errDiv.style.color = '#a55';
          errDiv.innerHTML = '<strong>Request failed:</strong> ' + err;
          outputEl.appendChild(errDiv);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Learn from Go';
        }
      };

      // Who is RILIE?
      selfBtn.onclick = function() {
        inputEl.value = 'Who are you?';
        submitBtn.click();
      };

      // Share
      shareBtn.onclick = async function() {
        const text = outputEl.textContent;
        if (navigator.share) {
          try { await navigator.share({ title: 'RILIE (3,6,9)', text: text.substring(0, 200), url: window.location.href }); } catch(e) {}
        } else {
          try {
            await navigator.clipboard.writeText(window.location.href + '\n' + text);
            shareBtn.classList.add('copied');
            setTimeout(function() { shareBtn.classList.remove('copied'); }, 1500);
          } catch(e) {}
        }
      };

      // Download
      downloadBtn.onclick = function() {
        const text = outputEl.textContent;
        if (!text) return;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'rilie-response.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Copy
      copyBtn.onclick = async function() {
        const text = outputEl.textContent;
        if (text) {
          try {
            await navigator.clipboard.writeText(text);
            copyBtn.classList.add('copied');
            const orig = copyBtn.innerHTML;
            copyBtn.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            setTimeout(function() { copyBtn.classList.remove('copied'); copyBtn.innerHTML = orig; }, 1500);
          } catch(e) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
        }
      };

      // Rewrite
      rewriteBtn.onclick = function() {
        if (lastStimulus) {
          inputEl.value = lastStimulus;
          submitBtn.click();
        }
      };

      // Enter to submit
      inputEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          submitBtn.click();
        }
      });

      // Sidebar actions
      document.getElementById('sidebar-new').onclick = function() {
        inputEl.value = '';
        outputEl.textContent = '';
        metaPanel.classList.remove('visible');
        outputActions.classList.remove('visible');
        healthFill.style.width = '100%';
        healthPct.textContent = '100';
        fileInput.value = '';
        lastStimulus = '';
        inputEl.focus();
      };

      document.getElementById('sidebar-history').onclick = function() {
        outputEl.textContent = 'History coming soon. Every conversation remembered.';
        outputActions.classList.remove('visible');
      };

      document.getElementById('sidebar-discover').onclick = function() {
        inputEl.focus();
      };

      document.getElementById('sidebar-spaces').onclick = function() {
        outputEl.textContent = 'Spaces coming soon. Collaborative rooms with shared context.';
        outputActions.classList.remove('visible');
      };

      document.getElementById('sidebar-finance').onclick = function() {
        outputEl.textContent = 'Finance coming soon. Real intelligence meets real numbers.';
        outputActions.classList.remove('visible');
      };

    });
  </script>

</body>
</html>